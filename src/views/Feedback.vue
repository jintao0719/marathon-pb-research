<template>
  <div class="feedback-page">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
      <div class="container navbar-content">
        <div class="logo" @click="$router.push('/')">
          <span class="logo-icon">ğŸƒ</span>
          <span class="logo-text">é©¬æ‹‰æ¾PBç ”ç©¶é™¢</span>
        </div>
        <div class="nav-links">
          <router-link to="/beginner" class="nav-link">å…¥é—¨ä¸“åŒº</router-link>
          <router-link to="/races" class="nav-link">å‚èµ›ä¸“åŒº</router-link>
          <router-link to="/advanced" class="nav-link">è¿›é˜¶ä¸“åŒº</router-link>
          <router-link to="/feedback" class="nav-link active">è·‘è€…å¿ƒå£°</router-link>
        </div>
      </div>
    </nav>

    <div class="main-container">
      <!-- å¤´éƒ¨åŒºåŸŸ -->
      <div class="feedback-hero">
        <div class="hero-content">
          <h1>ğŸƒâ€â™‚ï¸ ä¸ä¸‡åƒè·‘è€…åŒè¡Œ</h1>
          <p class="hero-subtitle">æ‚¨çš„æ¯ä¸€æ¡å»ºè®®ï¼Œéƒ½æ˜¯æˆ‘ä»¬å‰è¿›çš„åŠ¨åŠ›</p>
        </div>
      </div>

      <div class="content-wrapper">
        <!-- å·¦ä¾§ï¼šæƒ…æ„Ÿæ–‡æ¡ˆ -->
        <div class="inspiration-section">
          <div class="inspiration-card">
            <div class="quote-icon">ğŸ’¬</div>
            <h3>è‡´æ¯ä¸€ä½çƒ­çˆ±è·‘æ­¥çš„ä½ </h3>
            <div class="inspiration-text">
              <p>è¿˜è®°å¾—ç¬¬ä¸€æ¬¡è¸ä¸Šè·‘é“æ—¶çš„å¿å¿‘å—ï¼Ÿ</p>
              <p>è¿˜è®°å¾—çªç ´5å…¬é‡Œæ—¶çš„å–œæ‚¦å—ï¼Ÿ</p>
              <p>è¿˜è®°å¾—å†²è¿‡ç»ˆç‚¹çº¿æ—¶çš„æ³ªæ°´å—ï¼Ÿ</p>
              <br>
              <p><strong>è·‘æ­¥ï¼Œä¸åªæ˜¯ä¸€é¡¹è¿åŠ¨ï¼Œæ›´æ˜¯ä¸€ç§ç”Ÿæ´»æ€åº¦ã€‚</strong></p>
              <br>
              <p>æ¯ä¸€æ¬¡è¿ˆå‡ºçš„è„šæ­¥ï¼Œéƒ½æ˜¯å¯¹æ›´å¥½è‡ªå·±çš„è¿½æ±‚ï¼›</p>
              <p>æ¯ä¸€æ»´æµæ·Œçš„æ±—æ°´ï¼Œéƒ½æ˜¯å¯¹ç”Ÿå‘½çƒ­çˆ±çš„è¯æ˜ã€‚</p>
              <br>
              <p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ±‡èšä¸‡åƒè·‘è€…çš„åŠ›é‡ï¼Œ</p>
              <p>åˆ†äº«èµ›äº‹èµ„è®¯ã€è®­ç»ƒå¿ƒå¾—ã€è£…å¤‡æ¨èâ€¦â€¦</p>
              <p>åªä¸ºè®©æ›´å¤šäººæ„Ÿå—åˆ°è·‘æ­¥çš„é­…åŠ›ã€‚</p>
              <br>
              <p class="highlight">ğŸŒŸ æ‚¨çš„å»ºè®®ï¼Œæ˜¯æˆ‘ä»¬è¿›æ­¥çš„æ–¹å‘</p>
              <p class="highlight">ğŸŒŸ æ‚¨çš„åé¦ˆï¼Œæ˜¯æˆ‘ä»¬ä¼˜åŒ–çš„åŠ¨åŠ›</p>
              <br>
              <p>æ— è®ºæ˜¯ç½‘ç«™åŠŸèƒ½çš„æ”¹è¿›å»ºè®®ï¼Œ</p>
              <p>è¿˜æ˜¯èµ›äº‹ä¿¡æ¯çš„è¡¥å……å®Œå–„ï¼Œ</p>
              <p>äº¦æˆ–æ˜¯æ‚¨æƒ³åˆ†äº«çš„è·‘æ­¥æ•…äº‹â€¦â€¦</p>
              <br>
              <p><strong>æˆ‘ä»¬éƒ½æœŸå¾…å¬åˆ°æ‚¨çš„å£°éŸ³ï¼</strong></p>
              <br>
              <p class="slogan">ä¸€èµ·è·‘ï¼Œä¸€èµ·æ›´å¥½ï¼ğŸƒâ€â™€ï¸ğŸƒâ€â™‚ï¸</p>
            </div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šåé¦ˆè¡¨å• -->
        <div class="form-section">
          <div class="form-card">
            <h2>ğŸ“ æäº¤åé¦ˆ</h2>
            
            <form @submit.prevent="submitFeedback">
              <!-- åé¦ˆå†…å®¹ -->
              <div class="form-group">
                <label class="form-label">
                  åé¦ˆå†…å®¹ <span class="required">*</span>
                </label>
                <textarea
                  v-model="form.content"
                  class="form-textarea"
                  placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„å»ºè®®æˆ–åé¦ˆ..."
                  rows="6"
                  maxlength="1000"
                  required
                ></textarea>
                <div class="char-count">{{ form.content.length }}/1000</div>
              </div>

              <!-- å›¾ç‰‡ä¸Šä¼  -->
              <div class="form-group">
                <label class="form-label">ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼Œæœ€å¤š5å¼ ï¼‰</label>
                <div class="image-upload-area" @click="triggerFileInput">
                  <input
                    ref="fileInput"
                    type="file"
                    accept="image/*"
                    multiple
                    style="display: none"
                    @change="handleFileChange"
                  >
                  <div v-if="form.images.length === 0" class="upload-placeholder">
                    <span class="upload-icon">ğŸ“·</span>
                    <p>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</p>
                    <p class="upload-hint">æ”¯æŒ JPGã€PNG æ ¼å¼</p>
                  </div>
                  <div v-else class="image-preview-list">
                    <div
                      v-for="(image, index) in form.images"
                      :key="index"
                      class="image-preview-item"
                    >
                      <img :src="image" alt="é¢„è§ˆ">
                      <button
                        type="button"
                        class="remove-image-btn"
                        @click.stop="removeImage(index)"
                      >
                        âœ•
                      </button>
                    </div>
                    <div
                      v-if="form.images.length < 5"
                      class="add-more-images"
                      @click.stop="triggerFileInput"
                    >
                      <span>+</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- è”ç³»æ–¹å¼ -->
              <div class="form-group">
                <label class="form-label">è”ç³»æ–¹å¼ï¼ˆå¯é€‰ï¼‰</label>
                <input
                  v-model="form.contact"
                  type="text"
                  class="form-input"
                  placeholder="æ‰‹æœºå·æˆ–é‚®ç®±ï¼Œæ–¹ä¾¿æˆ‘ä»¬å›å¤æ‚¨"
                >
              </div>

              <!-- æäº¤æŒ‰é’® -->
              <button
                type="submit"
                class="submit-btn"
                :disabled="isSubmitting || !form.content.trim()"
              >
                <span v-if="isSubmitting">æäº¤ä¸­...</span>
                <span v-else>âœ¨ æäº¤åé¦ˆ</span>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- æˆåŠŸæç¤ºå¼¹çª— -->
    <div v-if="showSuccess" class="modal-overlay" @click="closeModal">
      <div class="modal-content" @click.stop>
        <div class="success-icon">ğŸ‰</div>
        <h3>åé¦ˆæäº¤æˆåŠŸï¼</h3>
        <p>æ„Ÿè°¢æ‚¨çš„å®è´µå»ºè®®ï¼Œæˆ‘ä»¬ä¼šè®¤çœŸé˜…è¯»æ¯ä¸€æ¡åé¦ˆã€‚</p>
        <button class="modal-btn" @click="closeModal">çŸ¥é“äº†</button>
      </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="footer">
      <div class="container">
        <p>Â© 2026 é©¬æ‹‰æ¾è·‘æ­¥çŸ¥è¯†ç½‘ | è®©æ¯ä¸€æ­¥éƒ½æ›´æœ‰æ„ä¹‰</p>
      </div>
    </footer>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { updatePageMeta, pageSEO } from '../utils/seo.js'

// è®¾ç½®é¡µé¢SEO
onMounted(() => {
  updatePageMeta({
    title: 'ç”¨æˆ·åé¦ˆ_æ„è§å»ºè®® - é©¬æ‹‰æ¾è·‘æ­¥çŸ¥è¯†ç½‘',
    description: 'æäº¤æ‚¨çš„å®è´µå»ºè®®å’Œåé¦ˆï¼Œå¸®åŠ©æˆ‘ä»¬æ”¹è¿›é©¬æ‹‰æ¾è·‘æ­¥çŸ¥è¯†ç½‘ï¼Œä¸ºè·‘è€…æä¾›æ›´å¥½çš„æœåŠ¡ã€‚',
    keywords: 'ç”¨æˆ·åé¦ˆ,æ„è§å»ºè®®,é©¬æ‹‰æ¾ç½‘ç«™,è·‘æ­¥ç¤¾åŒº'
  })
})

const fileInput = ref(null)
const isSubmitting = ref(false)
const showSuccess = ref(false)

const form = ref({
  content: '',
  images: [],
  contact: ''
})

// è§¦å‘æ–‡ä»¶é€‰æ‹©
const triggerFileInput = () => {
  fileInput.value?.click()
}

// å¤„ç†æ–‡ä»¶é€‰æ‹©
const handleFileChange = (event) => {
  const files = Array.from(event.target.files)
  const remainingSlots = 5 - form.value.images.length
  
  if (remainingSlots <= 0) {
    alert('æœ€å¤šåªèƒ½ä¸Šä¼ 5å¼ å›¾ç‰‡')
    return
  }
  
  const filesToProcess = files.slice(0, remainingSlots)
  
  filesToProcess.forEach(file => {
    if (!file.type.startsWith('image/')) {
      alert(`${file.name} ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶`)
      return
    }
    
    if (file.size > 5 * 1024 * 1024) {
      alert(`${file.name} è¶…è¿‡5MBé™åˆ¶`)
      return
    }
    
    const reader = new FileReader()
    reader.onload = (e) => {
      form.value.images.push(e.target.result)
    }
    reader.readAsDataURL(file)
  })
  
  // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
  event.target.value = ''
}

// ç§»é™¤å›¾ç‰‡
const removeImage = (index) => {
  form.value.images.splice(index, 1)
}

// æäº¤åé¦ˆ
const submitFeedback = async () => {
  if (!form.value.content.trim()) {
    alert('è¯·å¡«å†™åé¦ˆå†…å®¹')
    return
  }
  
  isSubmitting.value = true
  
  try {
    const response = await fetch('/api/feedback', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        content: form.value.content,
        images: form.value.images,
        contact: form.value.contact
      })
    })
    
    const data = await response.json()
    
    if (data.success) {
      showSuccess.value = true
      // é‡ç½®è¡¨å•
      form.value = {
        content: '',
        images: [],
        contact: ''
      }
    } else {
      alert(data.error || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  } catch (error) {
    console.error('æäº¤åé¦ˆå¤±è´¥:', error)
    console.error('é”™è¯¯è¯¦æƒ…:', error.message)
    alert('ç½‘ç»œé”™è¯¯: ' + error.message + '\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•')
  } finally {
    isSubmitting.value = false
  }
}

// å…³é—­å¼¹çª—
const closeModal = () => {
  showSuccess.value = false
}
</script>

<style scoped>
.feedback-page {
  min-height: 100vh;
  background: var(--bg-gray);
}

/* å¯¼èˆªæ  */
.navbar {
  background: white;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.navbar-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 64px;
}

.logo {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-size: 20px;
  font-weight: 700;
  color: var(--primary-blue);
}

.logo-icon {
  font-size: 28px;
}

.nav-links {
  display: flex;
  gap: 32px;
}

.nav-link {
  color: var(--text-dark);
  text-decoration: none;
  font-weight: 500;
  transition: color 0.2s;
}

.nav-link:hover {
  color: var(--primary-blue);
}

/* å¤´éƒ¨åŒºåŸŸ */
.feedback-hero {
  background: linear-gradient(135deg, #1E88E5 0%, #1565C0 100%);
  padding: 48px 0;
  text-align: center;
  color: white;
}

.feedback-hero h1 {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 12px;
}

.hero-subtitle {
  font-size: 16px;
  opacity: 0.9;
}

/* ä¸»å†…å®¹åŒº */
.main-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 40px 20px;
}

.content-wrapper {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 40px;
}

/* å·¦ä¾§æ–‡æ¡ˆ */
.inspiration-section {
  position: sticky;
  top: 100px;
  height: fit-content;
}

.inspiration-card {
  background: white;
  border-radius: 16px;
  padding: 32px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
}

.quote-icon {
  font-size: 32px;
  margin-bottom: 16px;
}

.inspiration-card h3 {
  font-size: 20px;
  font-weight: 600;
  color: var(--primary-blue);
  margin-bottom: 20px;
}

.inspiration-text {
  color: var(--text-dark);
  line-height: 1.8;
  font-size: 14px;
}

.inspiration-text p {
  margin-bottom: 8px;
}

.inspiration-text .highlight {
  color: var(--primary-blue);
  font-weight: 500;
}

.inspiration-text .slogan {
  font-size: 18px;
  font-weight: 600;
  color: var(--primary-orange);
  text-align: center;
  margin-top: 16px;
}

/* å³ä¾§è¡¨å• */
.form-section {
  position: sticky;
  top: 100px;
  height: fit-content;
}

.form-card {
  background: white;
  border-radius: 16px;
  padding: 32px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
}

.form-card h2 {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 24px;
  color: var(--text-dark);
}

.form-group {
  margin-bottom: 24px;
}

.form-label {
  display: block;
  font-weight: 500;
  margin-bottom: 8px;
  color: var(--text-dark);
}

.required {
  color: #f44336;
}

.form-textarea,
.form-input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  font-size: 14px;
  transition: border-color 0.2s;
  resize: vertical;
}

.form-textarea:focus,
.form-input:focus {
  outline: none;
  border-color: var(--primary-blue);
}

.char-count {
  text-align: right;
  font-size: 12px;
  color: var(--text-gray);
  margin-top: 4px;
}

/* å›¾ç‰‡ä¸Šä¼  */
.image-upload-area {
  border: 2px dashed #e0e0e0;
  border-radius: 8px;
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.2s;
}

.image-upload-area:hover {
  border-color: var(--primary-blue);
}

.upload-placeholder {
  color: var(--text-gray);
}

.upload-icon {
  font-size: 32px;
  display: block;
  margin-bottom: 8px;
}

.upload-hint {
  font-size: 12px;
  margin-top: 4px;
}

.image-preview-list {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.image-preview-item {
  position: relative;
  width: 80px;
  height: 80px;
  border-radius: 8px;
  overflow: hidden;
}

.image-preview-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.remove-image-btn {
  position: absolute;
  top: 4px;
  right: 4px;
  width: 20px;
  height: 20px;
  background: rgba(0, 0, 0, 0.5);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.add-more-images {
  width: 80px;
  height: 80px;
  border: 2px dashed #e0e0e0;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: var(--text-gray);
  cursor: pointer;
}

/* æäº¤æŒ‰é’® */
.submit-btn {
  width: 100%;
  padding: 14px 24px;
  background: linear-gradient(135deg, #1E88E5 0%, #1565C0 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  transition: opacity 0.2s;
}

.submit-btn:hover:not(:disabled) {
  opacity: 0.9;
}

.submit-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* æˆåŠŸå¼¹çª— */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 16px;
  padding: 40px;
  text-align: center;
  max-width: 400px;
  width: 90%;
}

.success-icon {
  font-size: 64px;
  margin-bottom: 16px;
}

.modal-content h3 {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 12px;
}

.modal-content p {
  color: var(--text-gray);
  margin-bottom: 24px;
}

.modal-btn {
  padding: 12px 32px;
  background: var(--primary-blue);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
}

/* é¡µè„š */
.footer {
  background: white;
  padding: 24px 0;
  text-align: center;
  color: var(--text-gray);
  font-size: 14px;
  margin-top: 40px;
}

/* å“åº”å¼ */
@media (max-width: 768px) {
  .content-wrapper {
    grid-template-columns: 1fr;
  }
  
  .inspiration-section,
  .form-section {
    position: static;
  }
  
  .feedback-hero h1 {
    font-size: 24px;
  }
}
</style>