<template>
  <div class="races-page">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
      <div class="container navbar-content">
        <div class="logo" @click="$router.push('/')">
          <span class="logo-icon">ğŸƒ</span>
          <span class="logo-text">é©¬æ‹‰æ¾PBç ”ç©¶é™¢</span>
        </div>
        <div class="nav-links">
          <router-link to="/beginner" class="nav-link">å…¥é—¨ä¸“åŒº</router-link>
          <router-link to="/races" class="nav-link active">å‚èµ›ä¸“åŒº</router-link>
          <router-link to="/advanced" class="nav-link">è¿›é˜¶ä¸“åŒº</router-link>
          <router-link to="/feedback" class="nav-link">è·‘è€…å¿ƒå£°</router-link>
        </div>
      </div>
    </nav>

    <div class="main-container">
      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="page-header">
        <h1>èµ›äº‹æŠ¥åä¸“åŒº</h1>
        <p>å…¨å›½é©¬æ‹‰æ¾èµ›äº‹ä¿¡æ¯æŸ¥è¯¢ï¼Œä¸€é”®ç›´è¾¾å®˜æ–¹æŠ¥å</p>
      </div>

      <!-- ç­›é€‰å™¨ -->
      <div class="filter-section card">
        <div class="filter-header">
          <span class="filter-icon">ğŸ”</span>
          <span class="filter-title">èµ›äº‹ç­›é€‰</span>
          <button v-if="hasActiveFilters" class="btn-reset" @click="resetFilters">
            é‡ç½®ç­›é€‰
          </button>
        </div>
        <div class="filter-row">
          <div class="filter-group">
            <label class="filter-label">æ¯”èµ›æ—¶é—´</label>
            <select v-model="filters.month" class="filter-select">
              <option value="">å…¨éƒ¨æ—¶é—´</option>
              <option value="2026-03">2026å¹´3æœˆ</option>
              <option value="2026-04">2026å¹´4æœˆ</option>
              <option value="2026-05">2026å¹´5æœˆ</option>
              <option value="2026-06">2026å¹´6æœˆ</option>
              <option value="2026-07">2026å¹´7æœˆ</option>
              <option value="2026-08">2026å¹´8æœˆ</option>
              <option value="2026-09">2026å¹´9æœˆ</option>
              <option value="2026-10">2026å¹´10æœˆ</option>
              <option value="2026-11">2026å¹´11æœˆ</option>
              <option value="2026-12">2026å¹´12æœˆ</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">ä¸¾åŠåœ°åŒº</label>
            <select v-model="filters.province" class="filter-select">
              <option value="">å…¨éƒ¨åœ°åŒº</option>
              <option value="åŒ—äº¬å¸‚">åŒ—äº¬å¸‚</option>
              <option value="ä¸Šæµ·å¸‚">ä¸Šæµ·å¸‚</option>
              <option value="æ±Ÿè‹çœ">æ±Ÿè‹çœ</option>
              <option value="æµ™æ±Ÿçœ">æµ™æ±Ÿçœ</option>
              <option value="æ¹–åŒ—çœ">æ¹–åŒ—çœ</option>
              <option value="å››å·çœ">å››å·çœ</option>
              <option value="é‡åº†å¸‚">é‡åº†å¸‚</option>
              <option value="ç”˜è‚ƒçœ">ç”˜è‚ƒçœ</option>
              <option value="äº‘å—çœ">äº‘å—çœ</option>
              <option value="å¹¿ä¸œçœ">å¹¿ä¸œçœ</option>
              <option value="ç¦å»ºçœ">ç¦å»ºçœ</option>
              <option value="å±±ä¸œçœ">å±±ä¸œçœ</option>
              <option value="æ²³åŒ—çœ">æ²³åŒ—çœ</option>
              <option value="æ±Ÿè¥¿çœ">æ±Ÿè¥¿çœ</option>
              <option value="é™•è¥¿çœ">é™•è¥¿çœ</option>
              <option value="è¾½å®çœ">è¾½å®çœ</option>
              <option value="å‰æ—çœ">å‰æ—çœ</option>
              <option value="å¹¿è¥¿å£®æ—è‡ªæ²»åŒº">å¹¿è¥¿å£®æ—è‡ªæ²»åŒº</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">èµ›äº‹ç­‰çº§</label>
            <select v-model="filters.level" class="filter-select">
              <option value="">å…¨éƒ¨ç­‰çº§</option>
              <option value="platinum">ğŸ† ç™½é‡‘æ ‡èµ›äº‹</option>
              <option value="gold">ğŸ¥‡ é‡‘æ ‡èµ›äº‹</option>
              <option value="silver">ğŸ¥ˆ é“¶æ ‡èµ›äº‹</option>
              <option value="bronze">ğŸ¥‰ é“œæ ‡èµ›äº‹</option>
              <option value="label">ğŸ“› æ ‡ç‰Œèµ›äº‹</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">æ¯”èµ›é¡¹ç›®</label>
            <select v-model="filters.distance" class="filter-select">
              <option value="">å…¨éƒ¨é¡¹ç›®</option>
              <option value="full">å…¨ç¨‹é©¬æ‹‰æ¾</option>
              <option value="half">åŠç¨‹é©¬æ‹‰æ¾</option>
              <option value="both">å…¨é©¬+åŠé©¬</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">æŠ¥åçŠ¶æ€</label>
            <select v-model="filters.regStatus" class="filter-select">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="open">ğŸ”¥ æŠ¥åä¸­</option>
              <option value="upcoming">â° å³å°†å¼€å§‹</option>
              <option value="pending">ğŸ”œ å³å°†å¼€å¯æŠ¥å</option>
            </select>
          </div>
        </div>
      </div>

      <!-- èµ›äº‹åˆ—è¡¨ -->
      <div class="races-content">
        <div class="section-header">
          <h2>èµ›äº‹åˆ—è¡¨</h2>
          <span class="result-count">å…± {{ filteredRaces.length }} åœºèµ›äº‹</span>
        </div>

        <div v-if="filteredRaces.length === 0" class="empty-state">
          <span class="empty-icon">ğŸ”</span>
          <p>æš‚æ— ç¬¦åˆæ¡ä»¶çš„èµ›äº‹</p>
          <button class="btn btn-secondary" @click="resetFilters">é‡ç½®ç­›é€‰</button>
        </div>

        <div v-else class="races-grid">
          <div 
            v-for="race in filteredRaces" 
            :key="race.id"
            class="race-card card"
            @click="goToDetail(race.id)"
          >
            <div class="race-image">
              <img :src="race.image" :alt="race.name" class="race-image-src">
              <span class="status-badge" :class="calculateRaceStatus(race).status">{{ calculateRaceStatus(race).label }}</span>
            </div>
            <div class="race-info">
              <h3>{{ race.name }}</h3>
              <div class="race-meta">
                <p class="meta-item">
                  <span class="meta-icon">ğŸ“</span>
                  {{ race.location }}
                </p>
                <p class="meta-item">
                  <span class="meta-icon">ğŸ“…</span>
                  {{ formatDate(race.date) }}
                </p>
                <p class="meta-item">
                  <span class="meta-icon">ğŸƒ</span>
                  {{ getDistancesLabel(race) }}
                </p>
              </div>
              <div v-if="calculateRaceStatus(race).status === 'open'" class="race-actions">
                <a 
                  :href="race.regLink" 
                  target="_blank" 
                  class="btn btn-primary btn-sm"
                  @click.stop
                >
                  å»æŠ¥å
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { useRouter } from 'vue-router'
import { getAllRaces } from '../api/races.js'
import { updatePageMeta, pageSEO, calculateRaceStatus } from '../utils/seo.js'
import { getAllRaces as getStaticRaces } from '../data/races-static.js'

const router = useRouter()
const races = ref([])
const loading = ref(false)

// è®¾ç½®é¡µé¢SEO
updatePageMeta(pageSEO.races)

// ç­›é€‰æ¡ä»¶
const filters = ref({
  month: '',
  province: '',
  level: '',
  distance: '',
  regStatus: ''
})

// è®¡ç®—æ˜¯å¦æœ‰æ¿€æ´»çš„ç­›é€‰æ¡ä»¶
const hasActiveFilters = computed(() => {
  return Object.values(filters.value).some(value => value !== '')
})

// çŠ¶æ€æ’åºæƒé‡ï¼ˆæ•°å­—è¶Šå°è¶Šé å‰ï¼‰
const statusWeight = {
  'open': 1,      // æŠ¥åä¸­
  'pending': 2,   // å³å°†å¼€å¯æŠ¥å
  'upcoming': 3,  // å³å°†å¼€å§‹
  'finished': 4   // æ¯”èµ›å·²ç»“æŸ
}

// èµ›äº‹ç­‰çº§æ’åºæƒé‡ï¼ˆæ•°å­—è¶Šå°è¶Šé å‰ï¼Œçº§åˆ«è¶Šé«˜ï¼‰
const levelWeight = {
  'platinum': 1,  // ç™½é‡‘æ ‡
  'gold': 2,      // é‡‘æ ‡
  'silver': 3,    // é“¶æ ‡
  'bronze': 4,    // é“œæ ‡
  'local': 5      // åœ°æ–¹èµ›
}

// ç­›é€‰åçš„èµ›äº‹åˆ—è¡¨
const filteredRaces = computed(() => {
  const filtered = races.value.filter(race => {
    // æœˆä»½ç­›é€‰
    if (filters.value.month && race.date) {
      const raceMonth = race.date.substring(0, 7)
      if (raceMonth !== filters.value.month) return false
    }
    
    // çœä»½ç­›é€‰
    if (filters.value.province) {
      // ä¼˜å…ˆä½¿ç”¨ province å­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ region å­—æ®µ
      const raceProvince = race.province || race.region
      if (!raceProvince || raceProvince !== filters.value.province) return false
    }
    
    // èµ›äº‹ç­‰çº§ç­›é€‰
    if (filters.value.level && race.level) {
      if (race.level !== filters.value.level) return false
    }
    
    // æ¯”èµ›é¡¹ç›®ç­›é€‰
    if (filters.value.distance) {
      if (filters.value.distance === 'both') {
        // å…¨é©¬+åŠé©¬ï¼šéœ€è¦æœ‰distancesæ•°ç»„ä¸”åŒ…å«fullå’Œhalf
        if (!race.distances || !race.distances.includes('full') || !race.distances.includes('half')) {
          return false
        }
      } else if (filters.value.distance === 'full') {
        // å…¨ç¨‹é©¬æ‹‰æ¾ï¼šdistanceä¸ºfullæˆ–æœ‰distancesåŒ…å«full
        if (race.distance !== 'full' && (!race.distances || !race.distances.includes('full'))) {
          return false
        }
      } else if (filters.value.distance === 'half') {
        // åŠç¨‹é©¬æ‹‰æ¾ï¼šdistanceä¸ºhalfæˆ–æœ‰distancesåŒ…å«half
        if (race.distance !== 'half' && (!race.distances || !race.distances.includes('half'))) {
          return false
        }
      }
    }
    
    // æŠ¥åçŠ¶æ€ç­›é€‰
    if (filters.value.regStatus) {
      const status = calculateRaceStatus(race).status
      if (status !== filters.value.regStatus) return false
    }
    
    return true
  })
  
  // æ’åºï¼šå…ˆæŒ‰çŠ¶æ€æ’åº -> åŒçŠ¶æ€ä¸‹æŒ‰èµ›äº‹çº§åˆ«é™åº -> åŒçº§åˆ«æŒ‰æ¯”èµ›æ—¥æœŸå€’æ’ï¼ˆæ—¥æœŸè¿‘çš„åœ¨å‰ï¼‰
  return filtered.sort((a, b) => {
    const statusA = calculateRaceStatus(a).status
    const statusB = calculateRaceStatus(b).status
    
    // æŒ‰çŠ¶æ€æƒé‡æ’åº
    const statusWeightA = statusWeight[statusA] || 5
    const statusWeightB = statusWeight[statusB] || 5
    
    if (statusWeightA !== statusWeightB) {
      return statusWeightA - statusWeightB
    }
    
    // åŒçŠ¶æ€ä¸‹æŒ‰èµ›äº‹çº§åˆ«é™åºï¼ˆçº§åˆ«é«˜çš„åœ¨å‰ï¼‰
    const levelA = levelWeight[a.level] || 5
    const levelB = levelWeight[b.level] || 5
    
    if (levelA !== levelB) {
      return levelA - levelB
    }
    
    // åŒçŠ¶æ€åŒçº§åˆ«ä¸‹æŒ‰æ¯”èµ›æ—¥æœŸå€’æ’ï¼ˆæ—¥æœŸè¿‘çš„åœ¨å‰ï¼‰
    const dateA = new Date(a.date)
    const dateB = new Date(b.date)
    return dateA - dateB
  })
})

// é‡ç½®ç­›é€‰
const resetFilters = () => {
  filters.value = {
    month: '',
    province: '',
    level: '',
    distance: '',
    regStatus: ''
  }
}

const loadRaces = async () => {
  loading.value = true
  try {
    // ä¼˜å…ˆä»APIè·å–æ•°æ®ï¼ˆæœ¬åœ°å¼€å‘ç¯å¢ƒï¼‰
    const apiRaces = await getAllRaces()
    if (apiRaces && apiRaces.length > 0) {
      races.value = apiRaces
      console.log(`å·²åŠ è½½ ${apiRaces.length} åœºèµ›äº‹ï¼ˆAPIæ•°æ®ï¼‰`)
    } else {
      // APIæ— æ•°æ®ï¼Œä½¿ç”¨é™æ€æ•°æ®ï¼ˆVerceléƒ¨ç½²å¤‡ç”¨ï¼‰
      const staticData = getStaticRaces()
      races.value = staticData
      console.log(`å·²åŠ è½½ ${staticData.length} åœºèµ›äº‹ï¼ˆé™æ€æ•°æ®ï¼‰`)
    }
  } catch (error) {
    console.error('APIåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é™æ€æ•°æ®:', error)
    // APIå¤±è´¥ï¼Œä½¿ç”¨é™æ€æ•°æ®
    const staticData = getStaticRaces()
    races.value = staticData
    console.log(`å·²åŠ è½½ ${staticData.length} åœºèµ›äº‹ï¼ˆé™æ€æ•°æ®ï¼‰`)
  } finally {
    loading.value = false
  }
}

const getDistanceLabel = (distance) => {
  const map = {
    '5k': '5å…¬é‡Œ',
    '10k': '10å…¬é‡Œ',
    'half': 'åŠç¨‹é©¬æ‹‰æ¾',
    'full': 'å…¨ç¨‹é©¬æ‹‰æ¾'
  }
  return map[distance] || distance
}

const getDistancesLabel = (race) => {
  // å¦‚æœæœ‰distancesæ•°ç»„ï¼Œæ˜¾ç¤ºæ‰€æœ‰è·ç¦»ç±»å‹
  if (race.distances && race.distances.length > 0) {
    const labels = race.distances.map(d => getDistanceLabel(d))
    return labels.join('ã€')
  }
  // å¦åˆ™æ˜¾ç¤ºå•ä¸ªdistance
  return getDistanceLabel(race.distance)
}

const formatDate = (dateStr) => {
  if (!dateStr) return ''
  const date = new Date(dateStr)
  return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`
}

const goToDetail = (id) => {
  router.push(`/race/${id}`)
}

onMounted(async () => {
  await loadRaces()
})
</script>

<style scoped>
.races-page {
  min-height: 100vh;
  background: var(--bg-gray);
}

/* å¯¼èˆªæ  */
.navbar {
  background: white;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.navbar-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 64px;
}

.logo {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-size: 20px;
  font-weight: 700;
  color: var(--primary-blue);
}

.logo-icon {
  font-size: 28px;
}

.nav-links {
  display: flex;
  gap: 32px;
}

.nav-link {
  text-decoration: none;
  color: var(--text-dark);
  font-weight: 500;
  transition: color 0.3s ease;
}

.nav-link:hover,
.nav-link.active {
  color: var(--primary-blue);
}

/* ä¸»å®¹å™¨ */
.main-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px;
}

/* é¡µé¢æ ‡é¢˜ */
.page-header {
  text-align: center;
  margin-bottom: 32px;
}

.page-header h1 {
  font-size: 28px;
  font-weight: 700;
  color: var(--text-dark);
  margin-bottom: 8px;
}

.page-header p {
  color: var(--text-gray);
}

/* ç­›é€‰å™¨æ ·å¼ */
.filter-section {
  margin-bottom: 24px;
  padding: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.filter-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-color);
}

.filter-icon {
  font-size: 18px;
}

.filter-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-dark);
  flex: 1;
}

.btn-reset {
  padding: 6px 14px;
  font-size: 13px;
  color: var(--primary-blue);
  background: transparent;
  border: 1px solid var(--primary-blue);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-reset:hover {
  background: var(--primary-blue);
  color: white;
}

.filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
}

.filter-group {
  flex: 1;
  min-width: 160px;
}

.filter-label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-gray);
  margin-bottom: 6px;
}

.filter-select {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  color: var(--text-dark);
  background: white;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 32px;
}

.filter-select:hover {
  border-color: var(--primary-blue);
}

.filter-select:focus {
  outline: none;
  border-color: var(--primary-blue);
  box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.1);
}

/* èµ›äº‹å†…å®¹ */
.races-content {
  margin-top: 0;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.section-header h2 {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-dark);
}

.result-count {
  color: var(--text-gray);
  font-size: 14px;
}

/* ç©ºçŠ¶æ€ */
.empty-state {
  text-align: center;
  padding: 64px 20px;
  background: white;
  border-radius: 12px;
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
  display: block;
}

.empty-state p {
  color: var(--text-gray);
  margin-bottom: 20px;
}

/* èµ›äº‹ç½‘æ ¼ */
.races-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}

.race-card {
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  overflow: hidden;
}

.race-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.race-image {
  height: 160px;
  position: relative;
  overflow: hidden;
}

.race-image-src {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.status-badge {
  position: absolute;
  top: 12px;
  right: 12px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
  z-index: 1;
  background: #4CAF50;
  color: white;
}

.status-badge.upcoming {
  background: var(--primary-orange);
}

.status-badge.closed {
  background: #9E9E9E;
}

.status-badge.finished {
  background: #757575;
}

.status-badge.pending {
  background: #2196F3;
}

.race-info {
  padding: 20px;
}

.race-info h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text-dark);
}

.race-meta {
  margin-bottom: 12px;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-gray);
  font-size: 13px;
  margin-bottom: 6px;
}

.meta-icon {
  font-size: 14px;
}

.race-actions {
  display: flex;
  justify-content: flex-end;
}

.btn-sm {
  padding: 8px 16px;
  font-size: 13px;
}

/* å“åº”å¼ */
@media (max-width: 1024px) {
  .races-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .main-container {
    padding: 16px;
  }

  .races-grid {
    grid-template-columns: 1fr;
  }
}
</style>
